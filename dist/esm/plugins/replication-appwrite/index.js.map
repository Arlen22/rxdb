{"version":3,"file":"index.js","names":["RxReplicationState","startReplicationOnLeaderShip","addRxPlugin","RxDBLeaderElectionPlugin","Databases","Query","lastOfArray","appwriteDocToRxDB","flatClone","Subject","RxAppwriteReplicationState","_RxReplicationState","replicationIdentifierHash","collection","pull","push","live","retryTime","autoStart","_this","call","_inheritsLoose","replicateAppwrite","options","primaryKey","schema","primaryPath","pullStream$","deletedField","waitForLeadership","databases","client","replicationPrimitivesPull","batchSize","modifier","stream$","asObservable","initialCheckpoint","handler","lastPulledCheckpoint","queries","or","greaterThan","updatedAt","and","equal","id","orderAsc","limit","result","listDocuments","databaseId","collectionId","lastDoc","documents","newCheckpoint","$id","$updatedAt","resultDocs","map","doc","checkpoint","undefined","replicationPrimitivesPush","rows","query","length","row","newDocumentState","docsOnServer","docsInDbById","forEach","docDataInDb","docId","conflicts","Promise","all","writeRow","docInDb","assumedMasterState","conflictHandler","isEqual","writeDoc","_deleted","createDocument","updateDocument","replicationState","replicationIdentifier","startBefore","start","bind","cancelBefore","cancel","channel","unsubscribe","subscribe","response","docData","payload","next"],"sources":["../../../../src/plugins/replication-appwrite/index.ts"],"sourcesContent":["import type {\n    SyncOptionsAppwrite,\n    AppwriteCheckpointType\n} from './appwrite-types';\nimport {\n    RxReplicationState,\n    startReplicationOnLeaderShip\n} from '../replication/index.ts';\nimport type {\n    ById,\n    ReplicationPullOptions,\n    ReplicationPushOptions,\n    RxCollection,\n    RxReplicationPullStreamItem,\n    RxReplicationWriteToMasterRow,\n    WithDeleted\n} from '../../types';\nimport { addRxPlugin } from '../../plugin.ts';\nimport { RxDBLeaderElectionPlugin } from '../leader-election/index.ts';\nimport {\n    Databases,\n    Query,\n    Models\n} from 'appwrite';\nimport { lastOfArray } from '../utils/utils-array.ts';\nimport { appwriteDocToRxDB } from './appwrite-helpers.ts';\nimport { flatClone } from '../utils/utils-object.ts';\nimport { Subject } from 'rxjs';\n\nexport class RxAppwriteReplicationState<RxDocType> extends RxReplicationState<RxDocType, AppwriteCheckpointType> {\n    constructor(\n        public readonly replicationIdentifierHash: string,\n        public readonly collection: RxCollection<RxDocType>,\n        public readonly pull?: ReplicationPullOptions<RxDocType, AppwriteCheckpointType>,\n        public readonly push?: ReplicationPushOptions<RxDocType>,\n        public readonly live: boolean = true,\n        public retryTime: number = 1000 * 5,\n        public autoStart: boolean = true\n    ) {\n        super(\n            replicationIdentifierHash,\n            collection,\n            '_deleted',\n            pull,\n            push,\n            live,\n            retryTime,\n            autoStart\n        );\n    }\n}\n\nexport function replicateAppwrite<RxDocType>(\n    options: SyncOptionsAppwrite<RxDocType>\n): RxAppwriteReplicationState<RxDocType> {\n    const collection: RxCollection<RxDocType> = options.collection;\n    const primaryKey = collection.schema.primaryPath;\n    const pullStream$: Subject<RxReplicationPullStreamItem<RxDocType, AppwriteCheckpointType>> = new Subject();\n\n    addRxPlugin(RxDBLeaderElectionPlugin);\n    options.live = typeof options.live === 'undefined' ? true : options.live;\n    options.deletedField = options.deletedField ? options.deletedField : '_deleted';\n    options.waitForLeadership = typeof options.waitForLeadership === 'undefined' ? true : options.waitForLeadership;\n\n    const databases = new Databases(options.client);\n\n    const replicationPrimitivesPull: ReplicationPullOptions<RxDocType, AppwriteCheckpointType> | undefined = options.pull ? {\n        batchSize: options.pull.batchSize,\n        modifier: options.pull.modifier,\n        stream$: pullStream$.asObservable(),\n        initialCheckpoint: options.pull.initialCheckpoint,\n        handler: async (\n            lastPulledCheckpoint: AppwriteCheckpointType | undefined,\n            batchSize: number\n        ) => {\n            const queries: string[] = [];\n            if (lastPulledCheckpoint) {\n                queries.push(\n                    Query.or([\n                        Query.greaterThan('$updatedAt', lastPulledCheckpoint.updatedAt),\n                        Query.and([\n                            Query.equal('$updatedAt', lastPulledCheckpoint.updatedAt),\n                            Query.greaterThan('$id', lastPulledCheckpoint.id)\n                        ])\n                    ])\n                );\n            }\n            queries.push(Query.orderAsc('$updatedAt'));\n            queries.push(Query.orderAsc('$id'));\n            queries.push(Query.limit(batchSize));\n\n            const result = await databases.listDocuments(\n                options.databaseId,\n                options.collectionId,\n                queries\n            );\n            const lastDoc = lastOfArray(result.documents);\n            const newCheckpoint: AppwriteCheckpointType | null = lastDoc ? {\n                id: lastDoc.$id,\n                updatedAt: lastDoc.$updatedAt\n            } : null;\n            const resultDocs: WithDeleted<RxDocType>[] = result.documents.map(doc => {\n                return appwriteDocToRxDB<RxDocType>(\n                    doc,\n                    primaryKey,\n                    options.deletedField\n                );\n            });\n\n            return {\n                checkpoint: newCheckpoint,\n                documents: resultDocs\n            };\n        }\n    } : undefined;\n\n    const replicationPrimitivesPush: ReplicationPushOptions<RxDocType> | undefined = options.push ? {\n        async handler(\n            rows: RxReplicationWriteToMasterRow<RxDocType>[]\n        ) {\n            let query: string;\n            if (rows.length > 1) {\n                query = Query.or(\n                    rows.map(row => {\n                        const id: string = (row.newDocumentState as any)[primaryKey];\n                        return Query.equal('$id', id);\n                    })\n                );\n            } else {\n                const id: string = (rows[0].newDocumentState as any)[primaryKey];\n                query = Query.equal('$id', id);\n            }\n            const docsOnServer = await databases.listDocuments(\n                options.databaseId,\n                options.collectionId,\n                [query]\n            );\n            const docsInDbById: ById<RxDocType> = {};\n            docsOnServer.documents.forEach(doc => {\n                const docDataInDb = appwriteDocToRxDB<RxDocType>(doc, primaryKey, options.deletedField);\n                const docId: string = doc.$id;\n                (docDataInDb as any)[primaryKey] = docId;\n                docsInDbById[docId] = docDataInDb;\n            });\n            const conflicts: WithDeleted<RxDocType>[] = [];\n            await Promise.all(\n                rows.map(async (writeRow) => {\n                    const docId = (writeRow.newDocumentState as any)[primaryKey];\n                    const docInDb: RxDocType | undefined = docsInDbById[docId];\n                    if (\n                        docInDb &&\n                        (\n                            !writeRow.assumedMasterState ||\n                            collection.conflictHandler.isEqual(docInDb as any, writeRow.assumedMasterState, 'replication-appwrite-push') === false\n                        )\n                    ) {\n                        // conflict\n                        conflicts.push(docInDb as any);\n                    } else {\n                        // no conflict\n                        const writeDoc: any = flatClone(writeRow.newDocumentState);\n                        delete writeDoc[primaryKey];\n                        writeDoc[options.deletedField] = writeDoc._deleted;\n                        if (options.deletedField !== '_deleted') {\n                            delete writeDoc._deleted;\n                        }\n\n                        let result: Models.Document;\n                        if (!docInDb) {\n                            result = await databases.createDocument(\n                                options.databaseId,\n                                options.collectionId,\n                                docId,\n                                writeDoc,\n                                // [\"read(\"any\")\"] // permissions (optional)\n                            );\n\n                        } else {\n                            result = await databases.updateDocument(\n                                options.databaseId,\n                                options.collectionId,\n                                docId,\n                                writeDoc,\n                                // [\"read(\"any\")\"] // permissions (optional)\n                            );\n                        }\n                    }\n                })\n            );\n            return conflicts;\n        }\n    } : undefined;\n\n    const replicationState = new RxAppwriteReplicationState<RxDocType>(\n        options.replicationIdentifier,\n        collection,\n        replicationPrimitivesPull,\n        replicationPrimitivesPush,\n        options.live,\n        options.retryTime,\n        options.autoStart\n    );\n\n    /**\n     * Subscribe to changes for the pull.stream$\n     */\n    if (options.live && options.pull) {\n        const startBefore = replicationState.start.bind(replicationState);\n        const cancelBefore = replicationState.cancel.bind(replicationState);\n        replicationState.start = () => {\n            const channel = 'databases.' + options.databaseId + '.collections.' + options.collectionId + '.documents';\n            const unsubscribe = options.client.subscribe(\n                channel,\n                (response) => {\n                    const docData = appwriteDocToRxDB<RxDocType>(response.payload, primaryKey, options.deletedField);\n                    pullStream$.next({\n                        checkpoint: {\n                            id: (docData as any)[primaryKey],\n                            updatedAt: (response.payload as any).$updatedAt\n                        },\n                        documents: [docData]\n                    });\n\n                }\n            );\n            replicationState.cancel = () => {\n                unsubscribe();\n                return cancelBefore();\n            };\n            return startBefore();\n        };\n    }\n\n    startReplicationOnLeaderShip(options.waitForLeadership, replicationState);\n    return replicationState;\n}\n"],"mappings":"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","ignoreList":[]}
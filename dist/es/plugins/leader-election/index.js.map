{"version":3,"file":"index.js","names":["createLeaderElection","getBroadcastChannelReference","removeBroadcastChannelReference","PROMISE_RESOLVE_TRUE","getFromMapOrCreate","LEADER_ELECTORS_OF_DB","WeakMap","LEADER_ELECTOR_BY_BROADCAST_CHANNEL","getLeaderElectorByBroadcastChannel","broadcastChannel","getForDatabase","token","name","oldDestroy","destroy","bind","elector","set","leaderElector","isLeader","multiInstance","waitForLeadership","awaitLeadership","then","onDestroy","db","has","get","die","rxdb","prototypes","RxDatabase","proto","RxDBLeaderElectionPlugin","hooks","preDestroyRxDatabase","after"],"sources":["../../../../src/plugins/leader-election/index.ts"],"sourcesContent":["/**\n * this plugin adds the leader-election-capabilities to rxdb\n */\n\nimport {\n    createLeaderElection,\n    LeaderElector,\n    BroadcastChannel\n} from 'broadcast-channel';\nimport {\n    getBroadcastChannelReference,\n    removeBroadcastChannelReference\n} from '../../rx-storage-multiinstance';\n\nimport type {\n    RxDatabase,\n    RxPlugin\n} from '../../types';\nimport { PROMISE_RESOLVE_TRUE, getFromMapOrCreate } from '../utils';\n\nconst LEADER_ELECTORS_OF_DB: WeakMap<RxDatabase, LeaderElector> = new WeakMap();\nconst LEADER_ELECTOR_BY_BROADCAST_CHANNEL: WeakMap<BroadcastChannel, LeaderElector> = new WeakMap();\n\n\n/**\n * Returns the leader elector of a broadcast channel.\n * Used to ensure we reuse the same elector for the channel each time.\n */\nexport function getLeaderElectorByBroadcastChannel(broadcastChannel: BroadcastChannel): LeaderElector {\n    return getFromMapOrCreate(\n        LEADER_ELECTOR_BY_BROADCAST_CHANNEL,\n        broadcastChannel,\n        () => createLeaderElection(broadcastChannel)\n    );\n}\n\n/**\n * @overwrites RxDatabase().leaderElector for caching\n */\nexport function getForDatabase(this: RxDatabase): LeaderElector {\n\n\n    const broadcastChannel = getBroadcastChannelReference(\n        this.token,\n        this.name,\n        this\n    );\n\n    /**\n     * Clean up the reference on RxDatabase.destroy()\n     */\n    const oldDestroy = this.destroy.bind(this);\n    this.destroy = function () {\n        removeBroadcastChannelReference(this.token, this);\n        return oldDestroy();\n    };\n\n\n    let elector = getLeaderElectorByBroadcastChannel(broadcastChannel);\n    if (!elector) {\n        elector = getLeaderElectorByBroadcastChannel(broadcastChannel);\n        LEADER_ELECTORS_OF_DB.set(\n            this,\n            elector\n        );\n    }\n\n    /**\n     * Overwrite for caching\n     */\n    this.leaderElector = () => elector;\n\n    return elector;\n}\n\nexport function isLeader(this: RxDatabase): boolean {\n    if (!this.multiInstance) {\n        return true;\n    }\n    return this.leaderElector().isLeader;\n}\n\nexport function waitForLeadership(this: RxDatabase): Promise<boolean> {\n    if (!this.multiInstance) {\n        return PROMISE_RESOLVE_TRUE;\n    } else {\n        return this.leaderElector()\n            .awaitLeadership()\n            .then(() => true);\n    }\n}\n\n/**\n * runs when the database gets destroyed\n */\nexport function onDestroy(db: RxDatabase) {\n    const has = LEADER_ELECTORS_OF_DB.get(db);\n    if (has) {\n        has.die();\n    }\n}\n\nexport const rxdb = true;\nexport const prototypes = {\n    RxDatabase: (proto: any) => {\n        proto.leaderElector = getForDatabase;\n        proto.isLeader = isLeader;\n        proto.waitForLeadership = waitForLeadership;\n    }\n};\n\nexport const RxDBLeaderElectionPlugin: RxPlugin = {\n    name: 'leader-election',\n    rxdb,\n    prototypes,\n    hooks: {\n        preDestroyRxDatabase: {\n            after: onDestroy\n        }\n    }\n};\n"],"mappings":"AAAA;AACA;AACA;;AAEA,SACIA,oBAAoB,QAGjB,mBAAmB;AAC1B,SACIC,4BAA4B,EAC5BC,+BAA+B,QAC5B,gCAAgC;AAMvC,SAASC,oBAAoB,EAAEC,kBAAkB,QAAQ,UAAU;AAEnE,IAAMC,qBAAyD,GAAG,IAAIC,OAAO,EAAE;AAC/E,IAAMC,mCAA6E,GAAG,IAAID,OAAO,EAAE;;AAGnG;AACA;AACA;AACA;AACA,OAAO,SAASE,kCAAkCA,CAACC,gBAAkC,EAAiB;EAClG,OAAOL,kBAAkB,CACrBG,mCAAmC,EACnCE,gBAAgB,EAChB,MAAMT,oBAAoB,CAACS,gBAAgB,CAAC,CAC/C;AACL;;AAEA;AACA;AACA;AACA,OAAO,SAASC,cAAcA,CAAA,EAAkC;EAG5D,IAAMD,gBAAgB,GAAGR,4BAA4B,CACjD,IAAI,CAACU,KAAK,EACV,IAAI,CAACC,IAAI,EACT,IAAI,CACP;;EAED;AACJ;AACA;EACI,IAAMC,UAAU,GAAG,IAAI,CAACC,OAAO,CAACC,IAAI,CAAC,IAAI,CAAC;EAC1C,IAAI,CAACD,OAAO,GAAG,YAAY;IACvBZ,+BAA+B,CAAC,IAAI,CAACS,KAAK,EAAE,IAAI,CAAC;IACjD,OAAOE,UAAU,EAAE;EACvB,CAAC;EAGD,IAAIG,OAAO,GAAGR,kCAAkC,CAACC,gBAAgB,CAAC;EAClE,IAAI,CAACO,OAAO,EAAE;IACVA,OAAO,GAAGR,kCAAkC,CAACC,gBAAgB,CAAC;IAC9DJ,qBAAqB,CAACY,GAAG,CACrB,IAAI,EACJD,OAAO,CACV;EACL;;EAEA;AACJ;AACA;EACI,IAAI,CAACE,aAAa,GAAG,MAAMF,OAAO;EAElC,OAAOA,OAAO;AAClB;AAEA,OAAO,SAASG,QAAQA,CAAA,EAA4B;EAChD,IAAI,CAAC,IAAI,CAACC,aAAa,EAAE;IACrB,OAAO,IAAI;EACf;EACA,OAAO,IAAI,CAACF,aAAa,EAAE,CAACC,QAAQ;AACxC;AAEA,OAAO,SAASE,iBAAiBA,CAAA,EAAqC;EAClE,IAAI,CAAC,IAAI,CAACD,aAAa,EAAE;IACrB,OAAOjB,oBAAoB;EAC/B,CAAC,MAAM;IACH,OAAO,IAAI,CAACe,aAAa,EAAE,CACtBI,eAAe,EAAE,CACjBC,IAAI,CAAC,MAAM,IAAI,CAAC;EACzB;AACJ;;AAEA;AACA;AACA;AACA,OAAO,SAASC,SAASA,CAACC,EAAc,EAAE;EACtC,IAAMC,GAAG,GAAGrB,qBAAqB,CAACsB,GAAG,CAACF,EAAE,CAAC;EACzC,IAAIC,GAAG,EAAE;IACLA,GAAG,CAACE,GAAG,EAAE;EACb;AACJ;AAEA,OAAO,IAAMC,IAAI,GAAG,IAAI;AACxB,OAAO,IAAMC,UAAU,GAAG;EACtBC,UAAU,EAAGC,KAAU,IAAK;IACxBA,KAAK,CAACd,aAAa,GAAGR,cAAc;IACpCsB,KAAK,CAACb,QAAQ,GAAGA,QAAQ;IACzBa,KAAK,CAACX,iBAAiB,GAAGA,iBAAiB;EAC/C;AACJ,CAAC;AAED,OAAO,IAAMY,wBAAkC,GAAG;EAC9CrB,IAAI,EAAE,iBAAiB;EACvBiB,IAAI;EACJC,UAAU;EACVI,KAAK,EAAE;IACHC,oBAAoB,EAAE;MAClBC,KAAK,EAAEZ;IACX;EACJ;AACJ,CAAC"}